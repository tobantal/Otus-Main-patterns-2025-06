# Отчет по реализации задания Домашнего задания №10 "Микросервис Авторизация пользователя"

## 1. Выполненные требования

### Задача сдана на проверку - **1 балл ✓**
- Все компоненты реализованы и интегрированы
- Исходный код находится в репозитории

### Код компилируется без ошибок, тесты выполняются успешно - **1 балл ✓**
- Сборка: `cmake -B build && cmake --build build`
- Все 40+ тестов проходят успешно
- Результаты тестирования в CI GitHub Actions

### Настроен CI для определения успешности - **2 балла ✓**
- GitHub Actions автоматически запускается при push на `master`/`develop`
- Компиляция, тестирование, отчет о покрытии кода
- Вывод процента покрытия тестами с помощью `gcov`/`lcov`

### Реализована аутентификация с помощью JWT - **2 балла ✓**
- **RSA подпись**: приватный ключ для генерации, публичный ключ для верификации
- **RSAJWTGenerator**: генерирует JWT с payload `{userId, gameId, role, exp}`
- **RSAJWTVerifier**: проверяет подпись и срок действия токена
- **JWTException**: централизованная обработка ошибок токенов
- Тесты: генерация, верификация валидного токена, отклонение поддельных токенов

### Реализован запрос на создание космического боя - **2 балла ✓**
- **Endpoint**: `POST /api/auth/game`
- **Request**: `{"organizerId": "org_123", "participants": ["player_1", "player_2"]}`
- **Response**: `{"gameId": "game_abc123", "status": "success"}`
- **GameRegistry**: thread-safe реестр игр с уникальными ID
- **Хранение**: участники сохраняются для проверки прав доступа

### Реализована проверка JWT на Игровом сервере - **2 балла ✓**
- **Endpoint**: `POST /api/battle/command`
- **Обработка**: извлечение токена из заголовка `Authorization: Bearer <token>`
- **Верификация**: проверка подписи и срока действия
- **Проверка прав**: пользователь должен быть участником игры
- **Ошибки**: возвращает 401 при отсутствии/невалидности токена

---

## 2. Архитектура микросервиса

### Сервис авторизации (Auth Service, порт 8095)

| Компонент | Функция |
| --- | --- |
| `AuthApplication` | Инициализация сервиса, регистрация компонентов в IoC |
| `AuthController` | HTTP обработчик для `/api/auth/game` и `/api/auth/token` |
| `GameRegistry` | Thread-safe реестр игр, создание и поиск по gameId |
| `RSAJWTGenerator` | Генерация JWT токенов с RSA подписью |

### Игровой сервер (Battle Service, порт 8090)

| Компонент | Функция |
| --- | --- |
| `BattleApplication` | Инициализация сервиса, регистрация CommandBuilder'ов |
| `BattleController` | HTTP обработчик для `/api/battle/command` с верификацией JWT |
| `GameManager` | Создание и кэширование очередей команд per-game |
| `RSAJWTVerifier` | Верификация JWT подписи и срока действия |

---

## 3. Взаимодействие сервисов

```

Клиент                 Auth Service              Battle Service
│                         │                          │
├──POST /api/auth/game─→  │                          │
│ (organizerId, participants)                        │
│                     [создаёт игру]                 │
│  ←─ gameId ──────────────┤                          │
│                          │                          │
├──POST /api/auth/token─→  │                          │
│ (gameId, userId)         │                          │
│              [генерирует JWT]                       │
│  ←─ token ────────────────┤                          │
│                          │                          │
├──POST /api/battle/command──────────────────────────→│
│ Authorization: Bearer <token>                       │
│ {command, params}    [верифицирует токен]           │
│                      [проверяет права доступа]      │
│  ←──── status: 200 ────────────────────────────────┤

```

---

## 4. Тестирование

### Unit-тесты JWT библиотеки
- ✓ Генерация и парсинг JWT payload
- ✓ Проверка срока действия токена
- ✓ Верификация RSA подписи с публичным ключом
- ✓ Отклонение поддельных токенов
- ✓ Отклонение истекших токенов

### Функциональные тесты Auth Service
- ✓ Создание новой игры с получением gameId
- ✓ Выдача JWT токена для участника
- ✓ Отклонение запроса токена для не-участника

### Функциональные тесты Battle Service
- ✓ Принятие команды с валидным JWT токеном
- ✓ Отклонение команды с невалидным токеном (HTTP 401)
- ✓ Отклонение команды без токена (HTTP 401)

### Интеграционные тесты
- ✓ Полный цикл: создание игры → выдача токена → отправка команды
- ✓ Проверка прав: токен для не-участника отклоняется
- ✓ Security: поддельные токены отклоняются
- ✓ Подробное логирование каждого шага для демонстрации

---

## 5. Ключевые реализованные механизмы

### Thread-safe операции
- `ThreadSafeMap<string, GameInfo>` для защиты от race conditions
- `std::shared_mutex` для concurrent read/write доступа
- `std::unique_lock` для write операций, `std::shared_lock` для read

### JWT верификация
- RSA-256 подпись для криптографической защиты
- Проверка сроков действия (`exp` claim)
- Извлечение и верификация payload

### Безопасное управление памятью
- `std::shared_ptr` для автоматического управления жизненным циклом
- `enable_shared_from_this` для безопасного захватывания в лямбдах HTTP обработчиков
- Избежание dangling pointers в async операциях

### IoC контейнер
- Централизованная регистрация компонентов
- Dependency Injection вместо жестких зависимостей
- Расширяемость без изменения существующего кода

---

## 6. SOLID принципы

| Принцип | Реализация |
| --- | --- |
| **S** - Single Responsibility | Каждый сервис отвечает за одну задачу: Auth выдает токены, Battle обрабатывает команды |
| **O** - Open/Closed | CommandBuilder регистрируются динамически, система открыта для расширения |
| **L** - Liskov Substitution | `IJWTGenerator` и `IJWTVerifier` - контракты, реализации взаимозаменяемы |
| **I** - Interface Segregation | Контроллеры зависят от специфичных интерфейсов, не от больших монолитов |
| **D** - Dependency Inversion | Все зависимости внедряются через IoC, нет жестких связей |

---

## 7. Используемые технологии и библиотеки

- **C++17** - современный стандарт с полноценной поддержкой smart pointers
- **cpp-httplib** - легковесный HTTP сервер/клиент
- **jwt-cpp** - генерация и верификация JWT с поддержкой RSA
- **nlohmann/json** - парсинг и формирование JSON
- **OpenSSL** - криптографические функции (RSA)
- **GoogleTest** - фреймворк для unit-тестирования
- **GitHub Actions** - CI/CD pipeline

---

## 8. Итоговая оценка

| Критерий | Баллы | Результат |
| :-- | :--: | :-- |
| Задача сдана на проверку | 1 | ✓ |
| Компиляция и тесты | 1 | ✓ |
| CI настроен | 2 | ✓ |
| JWT аутентификация | 2 | ✓ |
| Создание игры (запрос на Auth Service) | 2 | ✓ |
| Проверка JWT на Battle Service | 2 | ✓ |
| **ИТОГО** | **10** | **10/10** |

---

## 9. Примеры использования

### Создание игры
```

curl -X POST http://127.0.0.1:8095/api/auth/game \
-H "Content-Type: application/json" \
-d '{"organizerId":"org_123","participants":["player_1","player_2"]}'

# Response: {"gameId":"game_abc123","status":"success"}

```

### Получение токена
```

curl -X POST http://127.0.0.1:8095/api/auth/token \
-H "Content-Type: application/json" \
-d '{"gameId":"game_abc123","userId":"player_1"}'

# Response: {"token":"eyJhbGciOiJSUzI1NiIs...","status":"success"}

```

### Отправка команды с токеном
```

curl -X POST http://127.0.0.1:8090/api/battle/command \
-H "Content-Type: application/json" \
-H "Authorization: Bearer eyJhbGciOiJSUzI1NiIs..." \
-d '{"command":"Move","params":{"x":100,"y":200}}'

# Response: {"status":"success","command":"Move",...}

```

---

## 10. Заключение

- Реализован полнофункциональный микросервис авторизации, который обеспечивает безопасное управление правами доступа пользователей к игровым сеансам. 
- Система использует современные практики разработки (SOLID, паттерны, IoC, JWT), обеспечивает thread-safety и полностью покрыта тестами. 
- CI/CD pipeline автоматизирует проверку качества кода.
