name: CMake CI

on:
  push:
    branches: [ master, develop, smart-redirect-service ]
  pull_request:
    branches: [ master ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    
    steps:
    - name: 🔄 Checkout repository
      uses: actions/checkout@v3
      
    - name: 🛠 Install dependencies
      run: sudo apt-get update && sudo apt-get install -y cmake g++ make lcov
      
    - name: 🏗 Configure CMake (with coverage)
      run: |
        cmake -B build \
          -DCMAKE_BUILD_TYPE=Debug \
          -DCMAKE_CXX_FLAGS="--coverage -g -O0" \
          -DCMAKE_EXE_LINKER_FLAGS="--coverage" \
          -DCMAKE_SHARED_LINKER_FLAGS="--coverage"
      
    - name: ⚙️ Build
      run: cmake --build build --config Debug
    
    - name: 📊 Capture baseline coverage
      run: |
        cd ${{ github.workspace }}/build
        lcov --capture --initial --directory . --output-file coverage_base.info \
          --ignore-errors mismatch \
          --rc geninfo_unexecuted_blocks=1 || true
      
    - name: ✅ Run tests (verbose)
      run: |
        cd ${{ github.workspace }}
        ctest --test-dir build --output-on-failure --timeout 60 --verbose
    
    - name: 📊 Capture test coverage
      run: |
        cd ${{ github.workspace }}/build
        lcov --capture --directory . --output-file coverage_test.info \
          --ignore-errors mismatch \
          --rc geninfo_unexecuted_blocks=1 || true
        lcov --add-tracefile coverage_base.info \
             --add-tracefile coverage_test.info \
             --output-file coverage_total.info || true
        lcov --remove coverage_total.info '/usr/*' '*/tests/*' '*/_deps/*' \
          --output-file coverage_filtered.info \
          --ignore-errors unused || true
        
    - name: 📈 Coverage report
      run: |
        cd ${{ github.workspace }}/build
        echo "=== PROJECT COVERAGE ==="
        lcov --list coverage_filtered.info