name: CMake CI

on:
  push:
    branches: [ master, develop, smart-redirect-service ]
  pull_request:
    branches: [ master ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    
    steps:
    - name: 🔄 Checkout repository
      uses: actions/checkout@v3
      
    - name: 🛠 Install dependencies
      run: sudo apt-get update && sudo apt-get install -y cmake g++ make lcov
      
    - name: 🏗 Configure CMake (with coverage)
      run: |
        cmake -B build \
          -DCMAKE_BUILD_TYPE=Debug \
          -DCMAKE_CXX_FLAGS="--coverage -g -O0" \
          -DCMAKE_EXE_LINKER_FLAGS="--coverage"
      
    - name: ⚙️ Build
      run: cmake --build build --config Debug
      
    - name: ✅ Run tests
      run: ctest --test-dir build --output-on-failure --timeout 60 --verbose
    
    - name: 📊 Generate coverage
      run: |
        cd build
        lcov --capture --directory . --output-file coverage.info \
          --ignore-errors mismatch,unused \
          --rc geninfo_unexecuted_blocks=1
        lcov --remove coverage.info \
          '/usr/*' \
          '*/tests/*' \
          '*/_deps/*' \
          '*/CMakeFiles/*' \
          --output-file coverage_filtered.info \
          --ignore-errors unused
        
    - name: 📈 Show coverage
      run: |
        cd build
        echo "=== FILES WITH TEST COVERAGE ==="
        lcov --list coverage_filtered.info | grep -E "\.cpp|\.hpp" | grep -v "100.0%"
        echo ""
        echo "=== TOTAL ==="
        lcov --summary coverage_filtered.info