# Code Coverage —Å gcovr

## –ß—Ç–æ —Ç–∞–∫–æ–µ code coverage

Code coverage –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç, –∫–∞–∫–æ–π –ø—Ä–æ—Ü–µ–Ω—Ç –∫–æ–¥–∞ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è —Ç–µ—Å—Ç–∞–º–∏. –ò–∑–º–µ—Ä—è–µ—Ç—Å—è –ø–æ:
- **Lines** - –ø—Ä–æ—Ü–µ–Ω—Ç —Å—Ç—Ä–æ–∫ –∫–æ–¥–∞, –∫–æ—Ç–æ—Ä—ã–µ –≤—ã–ø–æ–ª–Ω–∏–ª–∏—Å—å
- **Functions** - –ø—Ä–æ—Ü–µ–Ω—Ç —Ñ—É–Ω–∫—Ü–∏–π, –∫–æ—Ç–æ—Ä—ã–µ –±—ã–ª–∏ –≤—ã–∑–≤–∞–Ω—ã
- **Branches** - –ø—Ä–æ—Ü–µ–Ω—Ç –≤–µ—Ç–æ–∫ (if/else, switch) –∫–æ—Ç–æ—Ä—ã–µ –±—ã–ª–∏ –ø—Ä–æ–π–¥–µ–Ω—ã

## –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç gcov

1. –ü—Ä–∏ –∫–æ–º–ø–∏–ª—è—Ü–∏–∏ —Å —Ñ–ª–∞–≥–æ–º `--coverage` –∫–æ–º–ø–∏–ª—è—Ç–æ—Ä –≤—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞—Ü–∏—é –≤ –∫–æ–¥
2. –ü—Ä–∏ –∑–∞–ø—É—Å–∫–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã —Å–æ–∑–¥–∞—é—Ç—Å—è `.gcda` —Ñ–∞–π–ª—ã —Å –¥–∞–Ω–Ω—ã–º–∏ –æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏
3. `gcovr` —á–∏—Ç–∞–µ—Ç `.gcda` –∏ `.gcno` (—Å–æ–∑–¥–∞—é—Ç—Å—è –ø—Ä–∏ –∫–æ–º–ø–∏–ª—è—Ü–∏–∏) –∏ —Å—á–∏—Ç–∞–µ—Ç –ø–æ–∫—Ä—ã—Ç–∏–µ

**–ß—Ç–æ —Å—á–∏—Ç–∞–µ—Ç—Å—è:**
- ‚úÖ –ò—Å–ø–æ–ª–Ω—è–µ–º—ã–µ —Å—Ç—Ä–æ–∫–∏ –∫–æ–¥–∞ (–ø—Ä–∏—Å–≤–∞–∏–≤–∞–Ω–∏—è, –≤—ã–∑–æ–≤—ã —Ñ—É–Ω–∫—Ü–∏–π, return)
- ‚ùå –ù–ï —Å—á–∏—Ç–∞—é—Ç—Å—è: –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏, –ø—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏, –æ–±—ä—è–≤–ª–µ–Ω–∏—è (—Ç–æ–ª—å–∫–æ header –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–≤)
- ‚ö†Ô∏è Header —Ñ–∞–π–ª—ã (.hpp) —Å—á–∏—Ç–∞—é—Ç—Å—è –¢–û–õ–¨–ö–û –µ—Å–ª–∏ –≤ –Ω–∏—Ö –µ—Å—Ç—å —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è (inline —Ñ—É–Ω–∫—Ü–∏–∏, template)

## –õ–æ–∫–∞–ª—å–Ω—ã–π –∑–∞–ø—É—Å–∫

### 1. –°–±–æ—Ä–∫–∞ —Å coverage

```bash
# –°–æ–∑–¥–∞—Ç—å –æ—Ç–¥–µ–ª—å–Ω—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è —Å–±–æ—Ä–∫–∏ —Å coverage
mkdir -p build-coverage
cd build-coverage

# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è CMake —Å —Ñ–ª–∞–≥–∞–º–∏ coverage
cmake .. -DCMAKE_BUILD_TYPE=Debug -DCMAKE_CXX_FLAGS="--coverage -g -O0"

# –°–±–æ—Ä–∫–∞
cmake --build .

# –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤ (–≥–µ–Ω–µ—Ä–∏—Ä—É—é—Ç—Å—è .gcda —Ñ–∞–π–ª—ã)
ctest --output-on-failure
```

### 2. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç—á–µ—Ç–∞

```bash
# –ò–∑ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ build-coverage
gcovr --root .. \
      --filter '../hw-14-final-project/.*' \
      --filter '../common/.*' \
      --exclude '.*/tests/.*' \
      --gcov-ignore-parse-errors=negative_hits.warn_once_per_file \
      --txt coverage.txt \
      --print-summary

# –ü—Ä–æ—Å–º–æ—Ç—Ä —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
cat coverage.txt
```

## –û–ø—Ü–∏–∏ gcovr

### `--root <path>`
–ö–æ—Ä–Ω–µ–≤–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –ø—Ä–æ–µ–∫—Ç–∞. –í—Å–µ –ø—É—Ç–∏ –±—É–¥—É—Ç –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ —ç—Ç–æ–π –ø–∞–ø–∫–∏.
- –ò–∑ `build-coverage` –∏—Å–ø–æ–ª—å–∑—É–π `--root ..`
- –ò–∑ –∫–æ—Ä–Ω—è –ø—Ä–æ–µ–∫—Ç–∞ –∏—Å–ø–æ–ª—å–∑—É–π `--root .`

### `--filter <regex>`
**–í–∫–ª—é—á–∞–µ—Ç** –≤ –æ—Ç—á–µ—Ç —Ç–æ–ª—å–∫–æ —Ñ–∞–π–ª—ã, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ —Ä–µ–≥—É–ª—è—Ä–Ω–æ–º—É –≤—ã—Ä–∞–∂–µ–Ω–∏—é.
```bash
--filter 'hw-14-final-project/.*'  # –í—Å–µ —Ñ–∞–π–ª—ã –∏–∑ hw-14-final-project/
--filter 'common/.*'               # –í—Å–µ —Ñ–∞–π–ª—ã –∏–∑ common/
```
–ú–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ `--filter` - –æ–Ω–∏ —Ä–∞–±–æ—Ç–∞—é—Ç –∫–∞–∫ OR.

### `--exclude <regex>`
**–ò—Å–∫–ª—é—á–∞–µ—Ç** –∏–∑ –æ—Ç—á–µ—Ç–∞ —Ñ–∞–π–ª—ã –ø–æ —Ä–µ–≥—É–ª—è—Ä–Ω–æ–º—É –≤—ã—Ä–∞–∂–µ–Ω–∏—é.
```bash
--exclude '.*/tests/.*'    # –ò—Å–∫–ª—é—á–∏—Ç—å –≤—Å–µ –∏–∑ –ø–∞–ø–æ–∫ tests/
--exclude '.*/test/.*'     # –ò—Å–∫–ª—é—á–∏—Ç—å –≤—Å–µ –∏–∑ –ø–∞–ø–æ–∫ test/
--exclude '.*/_deps/.*'    # –ò—Å–∫–ª—é—á–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
```

### `--gcov-ignore-parse-errors=negative_hits.warn_once_per_file`
–ò–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç –±–∞–≥–∏ gcov (negative hits). –ë–µ–∑ —ç—Ç–æ–≥–æ gcovr –º–æ–∂–µ—Ç —É–ø–∞—Å—Ç—å —Å –æ—à–∏–±–∫–æ–π.

### `--txt <filename>`
–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç–µ–∫—Å—Ç–æ–≤—ã–π –æ—Ç—á–µ—Ç –≤ —Ñ–∞–π–ª.

### `--html-details <filename>`
–°–æ—Ö—Ä–∞–Ω–∏—Ç—å HTML –æ—Ç—á–µ—Ç —Å –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–µ–π –ø–æ —Ñ–∞–π–ª–∞–º (—É–¥–æ–±–Ω–æ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞).

### `--print-summary`
–í—ã–≤–µ—Å—Ç–∏ –∏—Ç–æ–≥–æ–≤—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –Ω–∞ —ç–∫—Ä–∞–Ω.

## –ß—Ç–æ –ø–æ–ø–∞–¥–∞–µ—Ç –≤ –æ—Ç—á–µ—Ç

### –ü–æ–ø–∞–¥–∞—é—Ç:
- ‚úÖ –í—Å–µ `.cpp` —Ñ–∞–π–ª—ã –∏–∑ hw-14-final-project/ –∏ common/
- ‚úÖ `.hpp` —Ñ–∞–π–ª—ã —Å —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–µ–π (inline, template)
- ‚úÖ –ò—Å–ø–æ–ª–Ω—è–µ–º—ã–µ —Å—Ç—Ä–æ–∫–∏ –∫–æ–¥–∞

### –ù–ï –ø–æ–ø–∞–¥–∞—é—Ç:
- ‚ùå –§–∞–π–ª—ã –∏–∑ `/usr/include/` (—Å–∏—Å—Ç–µ–º–Ω—ã–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏)
- ‚ùå –§–∞–π–ª—ã –∏–∑ `_deps/` (–≤–Ω–µ—à–Ω–∏–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ —Ç–∏–ø–∞ googletest, Boost)
- ‚ùå –§–∞–π–ª—ã –∏–∑ `tests/` (—Å–∞–º–∏ —Ç–µ—Å—Ç—ã)
- ‚ùå –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã –±–µ–∑ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ (—á–∏—Å—Ç—ã–µ –∞–±—Å—Ç—Ä–∞–∫—Ç–Ω—ã–µ –∫–ª–∞—Å—Å—ã)
- ‚ùå –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –∏ –ø—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏

## –ò–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤

```
lines: 8.7% (47 out of 540)
functions: 8.6% (6 out of 70)
branches: 3.7% (44 out of 1178)
```

**Lines: 8.7%** - –∏–∑ 540 —Å—Ç—Ä–æ–∫ –∏—Å–ø–æ–ª–Ω—è–µ–º–æ–≥–æ –∫–æ–¥–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ 47
**Functions: 8.6%** - –∏–∑ 70 —Ñ—É–Ω–∫—Ü–∏–π –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–æ 6
**Branches: 3.7%** - –∏–∑ 1178 –≤–µ—Ç–æ–∫ (if/else) –ø–æ–∫—Ä—ã—Ç–æ 44

### –ü–æ—á–µ–º—É –Ω–∏–∑–∫–æ–µ –ø–æ–∫—Ä—ã—Ç–∏–µ?
–í –Ω–∞—à–µ–º –ø—Ä–æ–µ–∫—Ç–µ —Å–µ–π—á–∞—Å:
- –ï—Å—Ç—å —Ç–µ—Å—Ç—ã —Ç–æ–ª—å–∫–æ –Ω–∞ `RouteMatcher` (unit-—Ç–µ—Å—Ç—ã)
- –ù–µ—Ç —Ç–µ—Å—Ç–æ–≤ –Ω–∞ handlers, services, adapters
- –ú–Ω–æ–≥–æ –∫–æ–¥–∞ –±–µ–∑ —Ç–µ—Å—Ç–æ–≤: RedirectService, GetUserHandler, InMemoryRuleClient –∏ —Ç.–¥.

## HTML –æ—Ç—á–µ—Ç (–¥–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑)

```bash
# –ì–µ–Ω–µ—Ä–∞—Ü–∏—è HTML —Å –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç—è–º–∏
gcovr --root .. \
      --filter '../hw-14-final-project/.*' \
      --filter '../common/.*' \
      --exclude '.*/tests/.*' \
      --gcov-ignore-parse-errors=negative_hits.warn_once_per_file \
      --html-details coverage.html

# –û—Ç–∫—Ä—ã—Ç—å –≤ –±—Ä–∞—É–∑–µ—Ä–µ
xdg-open coverage.html
```

HTML –æ—Ç—á–µ—Ç –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç:
- –°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö —Ñ–∞–π–ª–æ–≤ —Å –ø—Ä–æ—Ü–µ–Ω—Ç–æ–º –ø–æ–∫—Ä—ã—Ç–∏—è
- –ú–æ–∂–Ω–æ –∫–ª–∏–∫–Ω—É—Ç—å –Ω–∞ —Ñ–∞–π–ª –∏ —É–≤–∏–¥–µ—Ç—å, –∫–∞–∫–∏–µ —Å—Ç—Ä–æ–∫–∏ –≤—ã–ø–æ–ª–Ω—è–ª–∏—Å—å (–∑–µ–ª–µ–Ω—ã–µ) –∏ –∫–∞–∫–∏–µ –Ω–µ—Ç (–∫—Ä–∞—Å–Ω—ã–µ)

## GitHub Actions CI

```yaml
- name: üìä Generate coverage
  run: |
    gcovr --root . \
          --filter 'hw-14-final-project/.*' \
          --filter 'common/.*' \
          --exclude '.*/tests/.*' \
          --gcov-ignore-parse-errors=negative_hits.warn_once_per_file \
          --txt coverage.txt \
          --print-summary
    cat coverage.txt

- name: üì§ Upload coverage report
  uses: actions/upload-artifact@v3
  with:
    name: coverage-report
    path: coverage.txt
```

## –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö

–ü–µ—Ä–µ–¥ –Ω–æ–≤—ã–º –∑–∞–ø—É—Å–∫–æ–º —Ç–µ—Å—Ç–æ–≤ –æ—á–∏—Å—Ç–∏ —Å—Ç–∞—Ä—ã–µ `.gcda`:

```bash
cd build-coverage
find . -name "*.gcda" -delete
ctest --output-on-failure
```

–ò–ª–∏ –ø—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ—Å–æ–±–µ—Ä–∏:

```bash
rm -rf build-coverage
mkdir build-coverage
cd build-coverage
cmake .. -DCMAKE_BUILD_TYPE=Debug -DCMAKE_CXX_FLAGS="--coverage -g -O0"
cmake --build .
ctest --output-on-failure
```

## –¶–µ–ª—å –ø–æ –ø–æ–∫—Ä—ã—Ç–∏—é

–î–ª—è —É—á–µ–±–Ω–æ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è:
- **‚â• 80%** lines coverage - —Ö–æ—Ä–æ—à–∏–π —É—Ä–æ–≤–µ–Ω—å
- **‚â• 90%** lines coverage - –æ—Ç–ª–∏—á–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å

–î–ª—è —ç—Ç–æ–≥–æ –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —Ç–µ—Å—Ç—ã –Ω–∞:
- RedirectService
- RedirectHandler
- GetUserHandler (–∏–ª–∏ —É–¥–∞–ª–∏—Ç—å)
- InMemoryRuleClient
- AlwaysTrueDSLEvaluator
- Environment